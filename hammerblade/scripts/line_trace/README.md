## Line Trace Generator ##
Parses trace information generated by Bladerunner to generate a line trace for all the tiles.

### Usage ###
**Step 1:** Compress the vanilla_trace_operation.csv trace file with compress_trace.py
```
python compress_trace.py --trace {vanilla_operaton_trace.csv}
                         --startpc {optional} {Starting PC (of kernel) for the beginning of line trace}
                         --endpc {optional} {Ending PC (of kernel) for the ending of line trace}
                         --fastnfake {optional} {Flag to generate line trace of 4x4 Bladerunner}
```
***Note:** if start and end PC are not specified, the line trace is generated for the entire trace file*

Example: 
```
python compress_trace.py --trace vanilla_operation_trace.py
                         --startpc 1cd2c
                         --endpc 1cd80
```

**Step 1b (optional)**: Compress the disassembly of PyTorch to use while printing trace in 'full' mode
```
python compress_asm.py --asm {path to disassembly file}
```
***Note:** this step needs to be performed before printing the trace in 'full' mode (step 2)*

Example: 
```
python compress_asm.py --asm /work/global/kr397/hb-pytorch/torch/riscv/kernel.dis   
```

**Step 2:** Prints the line trace between two PCs specified while running compress_trace.py

For every tile, the instructions can be printed in either `'lo'`, `'mid'`, `'hi'`, `'pc'` or `'full'`: 
- lo: single character code for stalls (listed below), `'@'` for instruction
- mid: 3 character code for stalls and instructions (listed below)
- hi: first 15 characters of all stalls and instructions
- pc: lowest two bytes of the PC of every instruction, `##ff` for stalls
- full: lowest two bytes of the PC + first 15 characters of actual instruction from asm, `##<complete stall code>` for stalls

***Note:** at least one of all modes must be provided to print the line trace*

```
python print_trace.py --mode {optional} {print mode for all tiles; 'lo', 'mid', 'hi'}
                      --lo {optional} {range of tiles to print in 'lo' mode}
                      --mid {optional} {range of tiles to print in 'mid' mode}
                      --hi {optional} {range of tiles to print in 'hi' mode}
```
Example:
```
python print_trace.py --mode lo
```
*Prints the line trace of all tiles in `lo` mode*
```
python print_trace.py --mode lo
                      --mid 4 9
```
*Prints the line trace of tiles [4-9) in mid, and all else in `lo`*
```
python print_trace.py --lo 0 3
                      --mid 5 9
                      --hi 10 11
```
*Prints the line trace of tiles [0-3) in `lo`, [5-9) in `mid`, [10-11) in `hi`*


***Note:** compress_trace.py creates a file trace.obj in the active directory; ensure that print_trace.py is run from the same directory so that it can access trace.obj*
***Note:** compress_asm.py generates a fule kernel.dic in the active directory; ensure that print_trace.py is run from the same directory*

### Key ###
**Integer instructions:**
```
"local_ld" : 'lld',
"local_st": 'lst',
"remote_ld_dram": 'ldr',
"remote_ld_global": 'lgl',
"remote_ld_group": 'lgr',
"remote_st_dram": 'sdr',
"remote_st_global": 'sgl',
"remote_st_group": 'sgr',
"local_flw": 'flw',
"local_fsw": 'fsw',
"remote_flw_dram": 'fdr',
"remote_flw_global": 'fgl',
"remote_flw_group": 'fgr',
"remote_fsw_dram": 'fsd',
"remote_fsw_global": 'fsg',
"remote_fsw_group": 'fsr',
"lr": 'lr ',
"lr_aq": 'lra',
"amoswap": 'ams',
"amoor": 'amo',
"beq": 'beq',
"bne": 'bne',
"blt": 'blt',
"bge": 'bge',
"bltu": 'blu',
"bgeu": 'bgu',
"jal": 'jal',
"jalr": 'jar',
"beq_miss": 'eqm',
"bne_miss": 'nem',
"blt_miss": 'ltm',
"bge_miss": 'gem',
"bltu_miss": 'lum',
"bgeu_miss": 'gum',
"jalr_miss": 'jam',
"sll": 'sll',
"slli": 'sli',
"srl": 'srl',
"srli": 'sri',
"sra": 'sra',
"srai": 'sai',
"add": 'add',
"addi": 'adi',
"sub": 'sub',
"lui": 'lui',
"auipc": 'apc',
"xor": 'xor',
"xori": 'xri',
"or": 'or ',
"ori": 'ori',
"and": 'and',
"andi": 'ani',
"slt": 'slt',
"slti": 'sli',
"sltu": 'slu',
"sltiu": 'siu',
"div": 'div',
"divu": 'diu',
"rem": 'rem',
"remu": 'reu',
"mul": 'mul',
"fence": 'fen',
"csrrw": 'crw',
"csrrs": 'crs',
"csrrc": 'crc',
"csrrwi": 'cwi',
"csrrsi": 'csi',
"csrrci": 'cci',
"unknown": 'unk'
```
**Floating point instructions:**
```
"fadd": 'fad',
"fsub": 'fsu',
"fmul": 'fmu',
"fsgnj": 'fgj',
"fsgnjn": 'fjn',
"fsgnjx": 'fjx',
"fmin": 'fmi',
"fmax": 'fma',
"fcvt_s_w": 'fcw',
"fcvt_s_wu": 'fcu',
"fmv_w_x": 'fwx',
"fmadd": 'fma',
"fmsub": 'fms',
"fnmsub": 'fns',
"fnmadd": 'fna',
"feq": 'feq',
"flt": 'flt',
"fle": 'fle',
"fcvt_w_s": 'fcs',
"fcvt_wu_s": 'fus',
"fclass": 'fcl',
"fmv_x_w": 'fxw',
"fdiv": 'fdi',
"fsqrt": 'fsq'
```
**Stalls:**
```
# Stall type : [lo code, mid code]
"stall_depend_dram_load" : ['D', '#DL'],
"stall_depend_group_load" : ['O', '#GR'] ,
"stall_depend_global_load" : ['G', '#GL'],
"stall_depend_local_load" : ['L', '#LL'],

"stall_depend_idiv" : ['H', '#ID'],
"stall_depend_fdiv" : ['Q', '#FD'],
"stall_depend_imul" : ['X', '#IM'],

"stall_amo_aq" : ['M', '#AQ'],
"stall_amo_rl" : ['K', '#RL'],

"stall_bypass" : ['Y', '#BP'],
"stall_lr_aq" : ['A', '#LR'],
"stall_fence" : ['F', '#FE'],
"stall_remote_req" : ['R', '#RR'],
"stall_remote_credit" : ['T', '#RC'],

"stall_fdiv_busy" : ['V', '#FB'],
"stall_idiv_busy" : ['U', '#IB'],

"stall_fcsr" : ['S', '#FC'],
"stall_remote_ld" : ['E', '#LD'],

"stall_remote_flw_wb" : ['W', '#FL'],

"bubble_branch_miss" : ['B', '#BM'],
"bubble_jalr_miss" : ['J', '#JM'],

"stall_ifetch_wait" : ['F', '#IF'],
"bubble_icache_miss" : ['I', '#IC'],
"icache_miss" : ['C', '#IM']
```
